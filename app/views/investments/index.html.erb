<div class="container py-5">
  <div class="d-md-flex my-md-4">
  	<h4 class="text-info flex-fill"><%= @account.account_type %><br></h4>
  	<div class="text-left text-md-right bg-light shadow-sm my-4 my-md-0 p-3 mr-0 rounded active-account">
  		<h5 class="mb-0"><%= @account.account_name %></h5>
  		<div>
  			<span class="text-secondary" style="font-size: 14px;"><em>Account No: <%= @account.account_number %></em><br></span>
  			<div>
          <%= link_to 'NEW ACCOUNT', new_account_path, class:'text-white badge badge-warning ml-md-1 p-2' %>
          <% if @current_user.accounts.count > 1 %>
            <%= link_to 'SWITCH ACCOUNT', '#', class: "text-white badge badge-warning ml-1 p-2", 'data-toggle': "modal", 'data-target': "#switchAccount" %>
          <% end %>
  			</div>
  		</div>
  	</div>
  </div>
  <div class="row">
    <div class="col-lg-2">
    	<ul id="sidebar" class="list-unstyled d-flex d-lg-block">
    		<li class="text-center text-lg-left flex-fill">
    			<a class="text-info bg-light d-block py-2 pl-lg-3 mb-2 account-tabs active" href="<%= edit_account_path(@account.id) %>">Account<br></a>
    		</li>
    		<li class="text-center text-lg-left flex-fill">
    			<a class="text-info bg-light d-block py-2 pl-lg-3 mb-2 account-tabs" href="/beneficiary">Banking<br></a>
    		</li>
    		<li class="text-center text-lg-left flex-fill">
    			<a class="text-info bg-light d-block py-2 pl-lg-3 mb-2 account-tabs" href="<%= investments_path %>">Investment<br></a>
    		</li>
    		<li class="text-center text-lg-left flex-fill">
    			<a class="text-info bg-light d-block py-2 pl-lg-3 mb-2 account-tabs" href="/settings">Dividend<br></a>
    		</li>
    	</ul>
    </div>
		<div class="col">
			<div class="border rounded p-4">
        <div>
          <h5>Investment Summary</h5>
          <hr>
          <div class="row row-cols-2 row-cols-lg-3 px-2">
  					<div class="col-6 col-lg-2 px-1">
  						<div class="text-right bg-light border rounded p-3 border-0 my-1">
  							<p class="mb-0 text-black-50" style="font-size: 14px;">Acquired</p>
  							<h6 class="text-info">Properties</h6>
  							<h4 class="text-black-50">
                  <%= @investments.pluck(:property_id).uniq.count %>
                </h4>
  						</div>
  					</div>
  					<div class="col-6 col-lg-2 px-1">
  						<div class="text-right bg-light border rounded p-3 border-0 my-1">
  							<p class="mb-0 text-black-50" style="font-size: 14px;">No. of</p>
  							<h6 class="text-info">Units</h6>
  							<h4 class="text-black-50">
                  <%= @investments.pluck(:invest_share).sum %>
                </h4>
  						</div>
  					</div>
  					<div class="col px-1">
  						<div class="text-right bg-light border rounded p-3 border-0 my-1">
  							<p class="mb-0 text-black-50" style="font-size: 14px;">Total</p>
  							<h6 class="text-info">Investment</h6>
  							<h4 class="text-black-50">$
                  <%= @investments.pluck(:invest_amount).sum %>
                </h4>
  						</div>
  					</div>
  					<div class="col px-1">
  						<div class="text-right bg-light border rounded p-3 border-0 my-1">
  							<p class="mb-0 text-black-50" style="font-size: 14px;">Total</p>
  							<h6 class="text-info">Fee &amp; Charges</h6>
  							<h4 class="text-black-50">$
                  <%= @investments.pluck(:trxn_fee).sum %>
                </h4>
  						</div>
  					</div>
  				</div>
          <hr>
          <h5 class="mt-5">Transaction Details</h5>
          <hr>
          <div class="table-responsive">
  					<table id="invTable" class="table table-hover table-bordered" style="width:100%">
  						<thead class="thead-light">
  							<tr>
  								<th></th>
  								<th>Date</th>
  								<th>Reference #</th>
  								<th>Property</th>
  								<th>Units</th>
  								<th>Investment</th>
  								<th>Fee & Charges</th>
  							</tr>
  						</thead>
  					</table>
  				</div>
          <hr>
          <div class="text-right my-4">
  					<a class="btn btn-info ml-md-2 button-block" href="/property">
  						NEW INVESTMENT
  					</a>
  				</div>
        </div>
			</div>
		</div>
	</div>
</div>

<!-- Modal to switch accounts -->
<%= form_with url:switch_account_path, local: true do |f| %>
	<div class="modal fade" role="dialog" tabindex="-1" id="switchAccount">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Select Account:</h5>
          <%= f.button 'button', class:"close", "data-dismiss": "modal", "aria-label": "Close" do %>
						<span aria-hidden="true">Ã—</span>
					<% end %>
				</div>
				<div class="modal-body">
          <%= select_tag "id", options_from_collection_for_select(@current_user.accounts, "id", "account_name"), class:"custom-select custom-select-lg" %>
				</div>
				<div class="modal-footer">
          <%= f.button 'SWITCH ACCOUNT', class:"btn btn-info" %>
				</div>
			</div>
		</div>
	</div>
<% end %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables.net/1.10.21/jquery.dataTables.min.js" integrity="sha512-KpU5s1pqURKNsloidq93ZyPKjZga0NgcRIberz+pZrt9e4JVpkZNYkd307Kl0G2cSc9YzLlRO85bIjBcxanG4g==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/dataTables.bootstrap4.min.js" integrity="sha512-OQlawZneA7zzfI6B1n1tjUuo3C5mtYuAWpQdg+iI9mkDoo7iFzTqnQHf+K5ThOWNJ9AbXL4+ZDwH7ykySPQc+A==" crossorigin="anonymous"></script>

<script type="text/javascript">
	data = <%== @investments.to_json %>;

	$(document).ready(function () {
		let table = $('#invTable').DataTable({
			data: data,
			columns: [
				{ data: null },
				{ data: 'created_at',
				  	render: function(data, type, row){
						let dateSplit = data.split('-');
						let daySplit = dateSplit[2].split('T');
						return type === "display" || type === "filter" ?
							daySplit[0] + '/' + dateSplit[1] + '/' + dateSplit[0] :
							data;
				  	}
				},
				{ data: 'trxn_ref',
					render: function(data, type, row){
						let render
						switch(row.pay_method){
							case 'paypal':
								return data + '<i class="ml-2 text-secondary fab fa-paypal"></i>';
								break;
							case 'card':
								return data + '<i class="ml-2 text-secondary fas fa-credit-card"></i>';
								break;
							default:
								return data;
						}
					}
				},
				{ data: 'property_name',
				  render: function(data, type, row){
					  return '<u><a href="/properties/' + row.property_id + '" target=_blank>' + data + '</a></u>'
				  }
				},
				{ data: 'invest_share', render: $.fn.dataTable.render.number( ',') },
				{ data: 'invest_amount', render: $.fn.dataTable.render.number( ',', '.', 2, '$ ') },
				{ data: null,
				  render: function(data, type, row){
					  return '$ ' + formatPrice(row.trxn_fee)
				  }
				}
			],

			"columnDefs": [ {
				"searchable": false,
				"orderable": false,
				"targets": 0
				},
				{className: "td-text-right", targets: [4, 5, 6]},
				{ width: "130px", targets: 2}
			],

			"order": [[ 1, 'dsc' ]]
		});

		table.on( 'order.dt search.dt', function () {
			table.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
				cell.innerHTML = i+1;
			});
		})
		.draw()
		.columns.adjust()
		// .responsive.recalc();
	});

	function formatPrice(val){
		const formatter = new Intl.NumberFormat('en-US', {
		  minimumFractionDigits: 2,
		  maximumFractionDigits: 2
		});

		return formatter.format(val);
	}
</script>
